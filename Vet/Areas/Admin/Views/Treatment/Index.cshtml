@using Entities;
@using System.Web;
@using Newtonsoft.Json;
@using Vet.Areas.Admin.Models;
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "_Layout";
}
@model PageModel<TreatmentEntity>
<div class="col-md-12 grid-margin">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="font-weight-bold mb-0">История лечения</h4>
        </div>
        <div>
            <a href="#" class="btn btn-primary btn-icon-text btn-rounded" id="test">
                <i class="ti-save  btn-icon-prepend"></i>скачать
            </a>
        </div>
    </div>
</div>
<table class="table table-striped" >
    <thead>
        <tr>
            <th>
               Питомец
            </th>
            <th>
               Лечащий врач
            </th>
            <th>
               Описание
            </th>
            <th>
               Диагноз
            </th>
           
        </tr>
    </thead>
    <tbody>
        @foreach(var item in Model.Objects)
        {
        <tr>
            <td class="py-1">
             @item.Inspection?.Animal?.NickName
            </td>
            <td>
                @(item.Inspection?.Vet?.Name+" "+ item.Inspection?.Vet?.FatherName)
            </td>
                <td style="max-width: 300px;

text-align: left;

overflow: hidden;

text-overflow: ellipsis;">
                    @Html.Raw(item.Description)
                
            </td>
             <td>
                @item.Diagnos?.Name
            </td>  
            
        </tr>
       }
    </tbody>
</table>
@if (Model.HasPreviousPage)
{
    <a asp-action="Index"
   asp-route-page="@(Model.PageNumber - 1)"
   class="btn btn-outline-dark">
        <i class="glyphicon glyphicon-chevron-left"></i>
        Назад
    </a>
}
@if (Model.HasNextPage)
{
    <a asp-action="Index"
   asp-route-page="@(Model.PageNumber + 1)"
   class="btn btn-outline-dark">
        Вперед
        <i class="glyphicon glyphicon-chevron-right"></i>
    </a>
}
@section Scripts{
    <script>
        $(document).ready(function () {
           
            $("#test").click(function () {
                var item = JSON.parse("@Html.Raw(HttpUtility.JavaScriptStringEncode(JsonConvert.SerializeObject(Model)))")
                var page = item.PageNumber;
                $.ajax({
                    url: '/Admin/Treatment/Download',
                    data: { page: page },
                    type: 'POST',
                    success: function () {
                        var xhr = new XMLHttpRequest();
                        xhr.open("GET", "Download/DownloadFile", true);
                        xhr.responseType = "blob";
                        xhr.onload = function (e) {
                            if (this.status == 200) {
                                var blob = this.response;

                                /* Get filename from Content-Disposition header */
                                var filename = "";
                                var disposition = xhr.getResponseHeader('Content-Disposition');
                                if (disposition && disposition.indexOf('attachment') !== -1) {
                                    var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                                    var matches = filenameRegex.exec(disposition);
                                    if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                                }

                                // This does the trick
                                var a = document.createElement('a');
                                a.href = window.URL.createObjectURL(blob);
                                a.download = filename;
                                a.dispatchEvent(new MouseEvent('click'));
                            }
                        }
                        xhr.send();
                    }
                });
            })
        })
    </script>
}